{% extends "admin/client_studio_layout.html" %}

{% block studio_content %}
<div class="max-w-7xl mx-auto animate-fade-in-up">
    <!-- Header -->
    <div class="mb-8 flex justify-between items-end">
        <div>
            <h1
                class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">
                Analytics Studio
            </h1>
            <p class="text-gray-500 mt-1">Real-time insights into your bot's performance.</p>
        </div>
        <div>
            <form action="{{ url_for('admin.client_stats', client_id=client.id, view_mode='export_csv') }}"
                method="get">
                <button type="submit"
                    class="flex items-center space-x-2 bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition-all text-sm font-medium">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span>Export CSV</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Navigation Tabs (Glassmorphism) -->
    <div
        class="bg-white/80 backdrop-blur-md border border-white/20 shadow-sm rounded-xl p-1 mb-8 inline-flex space-x-1">
        {% for tab_id, label in [('overview', 'Overview'), ('trends', 'Trends'), ('conversations', 'Logs'), ('events',
        'Events'), ('reports', 'Reports')] %}
        <a href="{{ url_for('admin.client_stats', client_id=client.id, view_mode=tab_id) }}" class="px-5 py-2 rounded-lg text-sm font-medium transition-all duration-200 
                  {% if view_mode == tab_id %}
                    bg-white text-blue-600 shadow-md ring-1 ring-black/5
                  {% else %}
                    text-gray-500 hover:text-gray-900 hover:bg-gray-100/50
                  {% endif %}">
            {{ label }}
        </a>
        {% endfor %}
    </div>

    <!-- VIEW: OVERVIEW -->
    {% if view_mode == 'overview' %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Card 1: Total Conversations -->
        <div
            class="relative overflow-hidden bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg shadow-blue-500/20 transform hover:-translate-y-1 transition-all duration-300">
            <div class="relative z-10">
                <p class="text-blue-100 text-sm font-medium uppercase tracking-wider">Total Conversations</p>
                <h3 class="text-4xl font-bold mt-1">{{ total_conversations }}</h3>
            </div>
            <div class="absolute right-0 bottom-0 opacity-10 transform translate-x-4 translate-y-4">
                <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                    </path>
                </svg>
            </div>
        </div>

        <!-- Card 2: AI Engagement Ratio -->
        <div
            class="relative overflow-hidden bg-white rounded-2xl p-6 shadow-sm border border-gray-100 transform hover:-translate-y-1 transition-all duration-300">
            <div class="flex items-center justify-between mb-4">
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wider">AI Chat Ratio</p>
                <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full font-bold">{{ ai_ratio
                    }}%</span>
            </div>
            <div class="relative pt-2">
                <div class="overflow-hidden h-2 text-xs flex rounded bg-indigo-50">
                    <div class="overflow-hidden h-2 text-xs flex rounded bg-indigo-50">
                        <div data-width="{{ ai_ratio }}%"
                            class="dynamic-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-500 transition-all duration-1000"
                            style="width: 0%">
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-xs text-gray-400 mt-4">Percentage of users who chat vs just clicking buttons.</p>
        </div>

        <!-- Card 3: Engagement Score -->
        <div
            class="relative overflow-hidden bg-white rounded-2xl p-6 shadow-sm border border-gray-100 transform hover:-translate-y-1 transition-all duration-300">
            <div class="flex items-center justify-between">
                <p class="text-gray-500 text-sm font-medium uppercase tracking-wider">Engagement Score</p>
                <div class="p-2 bg-green-50 rounded-lg">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
            <div class="flex items-baseline mt-2">
                <h3 class="text-3xl font-bold text-gray-900">{{ engagement_score }}</h3>
                <span class="ml-2 text-sm text-gray-400">/ 100</span>
            </div>
            <p class="text-xs text-green-600 mt-2 font-medium flex items-center">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
                Dynamic Metric
            </p>
        </div>
    </div>
    {% endif %}

    <!-- VIEW: TRENDS -->
    {% if view_mode == 'trends' %}
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8">
        <h3 class="text-lg font-bold text-gray-800 mb-6">Interaction Trends (Last 7 Days)</h3>
        <div class="relative h-80 w-full">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.2)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

            // Safe JSON parsing for Jinja variables to avoid linter errors
            const trendLabels = JSON.parse('{{ trend_data.labels | tojson | safe }}');
            const trendCounts = JSON.parse('{{ trend_data.counts | tojson | safe }}');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Interactions',
                        data: trendCounts,
                        borderColor: '#3b82f6',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#3b82f6',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [2, 4], color: '#f3f4f6' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        });
    </script>
    {% endif %}

    <!-- VIEW: CONVERSATIONS (LOGS) -->
    {% if view_mode == 'conversations' %}
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
            <h3 class="font-bold text-gray-800">Recent Logs</h3>
            <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded shadow-sm">Last 50 items</span>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-100">
                <thead class="bg-gray-50/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Details</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                    {% for log in logs %}
                    <tr class="hover:bg-gray-50/50 transition-colors">
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-400 font-mono">{{
                            log.timestamp.strftime('%H:%M Â· %d %b') }}</td>
                        <td class="px-6 py-3 whitespace-nowrap">
                            <span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if log.interaction_type == 'ai_chat' %}bg-purple-100 text-purple-800 border border-purple-200
                                {% else %}bg-green-100 text-green-800 border border-green-200{% endif %}">
                                {{ log.interaction_type }}
                            </span>
                        </td>
                        <td class="px-6 py-3 text-sm text-gray-700 break-words max-w-md">
                            {{ log.user_query }}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="px-6 py-12 text-center text-gray-400">
                            <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                </path>
                            </svg>
                            <p class="mt-2 text-sm">No activity recorded yet.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- VIEW: EVENTS (Simplified for consistency) -->
    {% if view_mode == 'events' %}
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 max-w-3xl mx-auto">
        <h3 class="font-bold text-gray-800 mb-6 text-xl">Top Actions</h3>
        <div class="space-y-6">
            {% for key, val in events_breakdown.items() %}
            <div class="group">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-600 group-hover:text-blue-600 transition-colors">{{ key
                        }}</span>
                    <span class="text-sm font-bold text-gray-900">{{ val }}</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                    <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                        <div data-width="{{ [val, 100]|min }}%"
                            class="dynamic-bar bg-gradient-to-r from-blue-500 to-indigo-500 h-2 rounded-full transition-all duration-1000 ease-out"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- VIEW: REPORTS (Redirect/Instructions) -->
    {% if view_mode == 'reports' %}
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center max-w-2xl mx-auto">
        <div class="inline-flex items-center justify-center p-4 bg-green-50 rounded-full mb-6 text-green-600">
            <svg class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Data Exports</h3>
        <p class="text-gray-500 mb-8">Download complete CSV logs of all bot interactions for external analysis in Excel
            or Google Sheets.</p>

        <form action="{{ url_for('admin.client_stats', client_id=client.id, view_mode='export_csv') }}" method="get">
            <button type="submit"
                class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-xl text-white bg-green-600 hover:bg-green-700 transition-all shadow-lg shadow-green-600/30">
                Download CSV Report
            </button>
        </form>
    </div>
    {% endif %}

</div>

<!-- Custom Animation Styles -->
<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
    }
</style>
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(function () {
            var bars = document.querySelectorAll('.dynamic-bar');
            bars.forEach(function (bar) {
                var w = bar.getAttribute('data-width');
                if (w) bar.style.width = w;
            });
        }, 100);
    });
</script>