{% extends "admin/client_studio_layout.html" %}

{% block studio_content %}
<div class="max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Compliance & Operations</h1>
            <p class="text-sm text-gray-500">Set operational boundaries and safety limits.</p>
        </div>
        <button type="submit" form="compliance-form"
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-medium">
            Save Settings
        </button>
    </div>

    <form id="compliance-form" method="POST" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left Column: Operations -->
        <div class="space-y-6">
            <!-- Card 1: Schedule -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Operational Hours</h3>
                <div id="schedule-container" class="space-y-4">
                    <!-- Days Generated by JS -->
                </div>
                <!-- Hidden Input to store JSON -->
                <input type="hidden" name="operating_hours" id="operating-hours-input"
                    value='{{ client.operating_hours or "" }}'>

                <p class="text-xs text-gray-500 mt-4 bg-blue-50 p-2 rounded text-center">
                    The bot will say it is "Closed" if a user asks during off-hours.
                </p>
            </div>

            <!-- Card 2: Timezone -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Timezone</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Restaurant Timezone</label>
                    <select name="timezone"
                        class="w-full border rounded-lg px-3 py-2 bg-white focus:ring-2 focus:ring-blue-500">
                        <option value="Asia/Jakarta" {% if client.timezone=='Asia/Jakarta' %}selected{% endif %}>
                            Asia/Jakarta (WIB)</option>
                        <option value="Asia/Makassar" {% if client.timezone=='Asia/Makassar' %}selected{% endif %}>
                            Asia/Makassar (WITA)</option>
                        <option value="Asia/Jayapura" {% if client.timezone=='Asia/Jayapura' %}selected{% endif %}>
                            Asia/Jayapura (WIT)</option>
                        <option value="UTC" {% if client.timezone=='UTC' %}selected{% endif %}>UTC</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Right Column: Safety & Compliance -->
        <div class="space-y-6">
            <!-- Card 3: Human Handoff -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Human Handoff Triggers</h3>
                <div class="space-y-3">
                    <label class="block text-sm font-medium text-gray-700">Emergency Keywords</label>
                    <textarea name="human_handoff_triggers" rows="4"
                        class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 text-sm"
                        placeholder="scam, police, manager, human, complaint">{{ kb.human_handoff_triggers or '' }}</textarea>
                    <p class="text-xs text-gray-500">
                        Comma-separated. If a user message contains these words, the bot will trigger a "Handoff" event
                        and stop replying autonomously (if configured).
                    </p>
                </div>
            </div>

            <!-- Card 4: Legal -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Legal Links</h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Privacy Policy URL</label>
                    <input type="url" name="privacy_policy_url" value="{{ client.privacy_policy_url or '' }}"
                        placeholder="https://example.com/privacy"
                        class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
    const hiddenInput = document.getElementById('operating-hours-input');
    const container = document.getElementById('schedule-container');

    // Parse existing data or Default
    let scheduleData = {};
    try {
        const raw = hiddenInput.value;
        if (raw) scheduleData = JSON.parse(raw);
    } catch (e) { console.error("JSON Parse Error", e); }

    // Render Days
    days.forEach(day => {
        const data = scheduleData[day] || { is_closed: false, start: '09:00', end: '21:00' };

        const row = document.createElement('div');
        row.className = "flex items-center justify-between py-2 border-b last:border-0";
        row.innerHTML = `
            <div class="w-24 capitalize font-medium text-gray-700">${day}</div>
            <div class="flex items-center gap-3">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" class="sr-only peer toggle-status" data-day="${day}" ${!data.is_closed ? 'checked' : ''}>
                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500 relative"></div>
                </label>
                <input type="time" class="border rounded px-2 py-1 text-sm time-input" data-day="${day}" data-type="start" value="${data.start}" ${data.is_closed ? 'disabled' : ''}>
                <span class="text-gray-400">-</span>
                <input type="time" class="border rounded px-2 py-1 text-sm time-input" data-day="${day}" data-type="end" value="${data.end}" ${data.is_closed ? 'disabled' : ''}>
            </div>
        `;
        container.appendChild(row);
    });

    // Event Delegation for updates
    container.addEventListener('input', updateJSON);
    container.addEventListener('change', (e) => {
        if (e.target.classList.contains('toggle-status')) {
            const day = e.target.dataset.day;
            const isOpen = e.target.checked;
            // Toggle Inputs
            const inputs = document.querySelectorAll(`.time-input[data-day="${day}"]`);
            inputs.forEach(input => input.disabled = !isOpen);
        }
        updateJSON();
    });

    function updateJSON() {
        const newData = {};
        days.forEach(day => {
            const toggle = document.querySelector(`.toggle-status[data-day="${day}"]`);
            const start = document.querySelector(`.time-input[data-day="${day}"][data-type="start"]`).value;
            const end = document.querySelector(`.time-input[data-day="${day}"][data-type="end"]`).value;

            newData[day] = {
                is_closed: !toggle.checked,
                start: start,
                end: end
            };
        });
        hiddenInput.value = JSON.stringify(newData);
    }
</script>
<style>
    /* Custom Toggle positioning adjustment if needed */
    .peer:checked~.relative.peer-checked\:bg-green-500 {
        background-color: #10b981;
    }

    .peer:checked:after:translate-x-full {
        transform: translateX(100%);
    }

    .after\:absolute:after {
        position: absolute;
    }
</style>
{% endblock %}