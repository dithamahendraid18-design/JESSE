<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ client.restaurant_name }} - Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png"
        href="{{ resolve_file(client.knowledge_base.avatar_image, 'avatars') if client.knowledge_base and client.knowledge_base.avatar_image else url_for('static', filename='img/favicon.png') }}">
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --book-theme-color: {
                    {
                    client.knowledge_base.book_theme_color or client.theme_color or '#8B4513'
                }
            }

            ;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: transparent !important;
        }

        /* 3D Scene Setup */
        .scene {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 2000px;
        }

        /* Mobile first book size - updated for Single Page Desktop */
        .book {
            position: relative;
            width: 90vw;
            max-width: 600px;
            aspect-ratio: 3/5;
            height: auto;
            max-height: 85vh;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.15, 0, 0.15, 1);
        }

        /* CRITICAL FIX: Force concrete height on mobile for scroll height calculation */
        @media (max-width: 768px) {

            /* HEIGHT-DRIVEN SIZING: Prevents distortion and guarantees scroll height */
            .book {
                height: 75vh !important;
                width: auto !important;
                /* Let width adapt to ratio */
                aspect-ratio: 3/5 !important;
                max-width: 90vw;
                /* Safety cap */
            }

            /* ISOLATION SHIELD: Prevent browser gestures on containers */
            .book,
            .page,
            .face {
                touch-action: none;
                cursor: default !important;
                /* Prevent tap highlight/delay */
            }

            /* HOLE IN SHIELD: Explicitly allow vertical scroll on content */
            .menu-grid {
                touch-action: pan-y !important;
                -webkit-user-select: auto !important;
                /* Ensure content is interactable */
                -moz-user-select: auto !important;
                user-select: auto !important;
            }
        }

        /* Page Styling */
        .page {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            transform-origin: left center;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.15, 0, 0.15, 1), opacity 0.4s ease;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            /* background-color: var(--book-theme-color) !important; REMOVED to fix 3D Same Sheet issue */
            border-radius: 4px 12px 12px 4px;
            opacity: 1;
            visibility: visible;
            will-change: transform;
            -webkit-font-smoothing: antialiased;
        }

        /* Force hardware acceleration for content */
        .page .face {
            transform: translateZ(0);
            will-change: opacity;
        }

        .page.flipped {
            transform: rotateY(-180deg);
            box-shadow: 20px 0 30px rgba(0, 0, 0, 0.3);
        }

        .page.discarded {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .flipped {
            transform: rotateY(-180deg);
        }

        /* Front and Back of Pages */
        .face {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            overflow: hidden;
            background-color: #8B4513;
            /* Physical Fallback */
            background-color: var(--book-theme-color) !important;
            padding: 24px;
            display: flex;
            flex-direction: column;
            border-left: 4px solid rgba(0, 0, 0, 0.05);
            isolation: isolate;
        }

        /* Back Page Logic: Blank/Texture for "Discarded" pages */
        .face.back {
            transform: rotateY(180deg);
            border-left: none;
            border-right: 4px solid rgba(0, 0, 0, 0.05);
            background: var(--book-theme-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .face.back::after {
            content: '';
        }

        /* ... rest of CSS ... */
        .face {
            color: var(--book-text-color);
        }

        h2,
        h3 {
            color: var(--book-text-color);
        }

        .text-gray-800,
        .text-gray-900,
        .text-gray-600,
        .text-gray-500,
        .text-gray-400 {
            color: var(--book-text-color) !important;
        }

        /* Menu Grid Scroll Enhancement */
        .menu-grid {
            flex: 1;
            overflow-y: auto !important;
            overflow-x: hidden;
            padding-right: 4px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
            -webkit-overflow-scrolling: touch;
        }

        /* Scrollbar Hiding (Global) */
        ::-webkit-scrollbar {
            width: 0px !important;
            height: 0px !important;
            display: none !important;
            background: transparent;
        }

        /* Firefox */
        * {
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
        }

        .menu-grid::-webkit-scrollbar {
            display: none;
        }

        /* Visual Spine Shadow */
        .face::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 15px;
            height: 100%;
            background: linear-gradient(to right, rgba(0, 0, 0, 0.15), transparent);
            z-index: 5;
            pointer-events: none;
        }

        .face.back::before {
            left: auto;
            right: 0;
            background: linear-gradient(to left, rgba(0, 0, 0, 0.15), transparent);
        }

        /* Image Shine/Frame Effect */
        .menu-item-image {
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2), 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }


        /* TOC Shimmer */

        /* TOC Shimmer */
        .toc-item {
            position: relative;
            overflow: hidden;
        }

        .toc-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .toc-item:hover::after {
            left: 100%;
        }

        .border-gray-50,
        .border-b {
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* If dark theme, borders should be light */
        /* Lightbox */
        #lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            cursor: zoom-out;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #lightbox.show {
            display: flex;
            opacity: 1;
        }

        #lightbox img {
            max-width: 90%;
            max-height: 90%;
            margin: auto;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #lightbox.show img {
            transform: scale(1);
        }

        .close-lightbox {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            z-index: 10000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .close-lightbox:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg) scale(1.1);
            border-color: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center">

    <script>
        // Set dynamic text color based on brightness of theme color
        (function () {
            let themeColor = "{{ client.knowledge_base.book_theme_color or client.theme_color or '#8B4513' }}";

            // NUCLEAR FIX: Ensure color is 100% opaque. 
            // If it's RGBA, convert to solid RGB.
            if (themeColor.startsWith('rgba')) {
                const parts = themeColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);
                if (parts) {
                    themeColor = `rgb(${parts[1]}, ${parts[2]}, ${parts[3]})`;
                }
            } else if (themeColor.length > 7 && themeColor.startsWith('#')) {
                // If #rrggbbaa, strip aa
                themeColor = themeColor.substring(0, 7);
            }

            // Force the CSS variable to be the sanitized opaque color
            document.documentElement.style.setProperty('--book-theme-color', themeColor);

            function hexToRgb(hex) {
                if (!hex || hex[0] !== '#') return { r: 139, g: 69, b: 19 }; // Default Brown
                if (hex.length === 4) {
                    hex = '#' + hex[1] + hex[1] + hex[2] + hex[2] + hex[3] + hex[3];
                }
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return { r, g, b };
            }

            const rgb = themeColor.startsWith('rgb') ?
                { r: parseInt(themeColor.match(/\d+/g)[0]), g: parseInt(themeColor.match(/\d+/g)[1]), b: parseInt(themeColor.match(/\d+/g)[2]) } :
                hexToRgb(themeColor);

            const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
            const textColor = brightness > 128 ? '#1f2937' : '#ffffff';
            const mutedText = brightness > 128 ? '#4b5563' : 'rgba(255,255,255,0.7)';

            document.documentElement.style.setProperty('--book-theme-color-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);
            document.documentElement.style.setProperty('--book-text-color', textColor);
            document.documentElement.style.setProperty('--book-text-muted', mutedText);

            // Reinforce background color on all components directly
            window.addEventListener('DOMContentLoaded', () => {
                document.querySelectorAll('.face').forEach(el => {
                    el.style.backgroundColor = themeColor;
                    el.style.opacity = '1';
                });
            });
        })();
    </script>

    <div class="scene">
        <div class="book" id="book">
            <!-- Page 0: Cover (Front), Blank (Back) -->
            <div class="page z-[60]" id="page-0" style="background-color: var(--book-theme-color) !important;">
                {% set welcome_bg = '' %}
                {% if client.knowledge_base.book_cover_image %}
                {% set welcome_bg = resolve_file(client.knowledge_base.book_cover_image, 'menu') %}
                {% endif %}

                <div id="cover-face-front"
                    class="face front flex flex-col items-center justify-center text-center p-8 text-white relative"
                    style="background-color: var(--book-theme-color) !important;">
                    <script>
                        const coverEl = document.getElementById('cover-face-front');
                        if (coverEl) {
                            const bookColor = "{{ client.knowledge_base.book_theme_color or client.theme_color or '#8B4513' }}";
                            coverEl.style.backgroundColor = bookColor;
                            const bgUrl = "{{ welcome_bg }}";
                            if (bgUrl) {
                                coverEl.style.backgroundImage = "linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('" + bgUrl + "')";
                                coverEl.style.backgroundSize = "{{ client.knowledge_base.book_cover_style or 'cover' }}";
                                coverEl.style.backgroundRepeat = "no-repeat";
                                coverEl.style.backgroundPosition = "center";
                            }
                        }
                    </script>

                    <div class="absolute inset-2 border border-white/30 rounded-lg pointer-events-none"></div>

                    {% if client.knowledge_base.book_logo_image %}
                    <img src="{{ resolve_file(client.knowledge_base.book_logo_image, 'menu') }}"
                        class="w-24 h-24 rounded-full border-4 border-white shadow-lg mb-6 object-cover pointer-events-none">
                    {% elif client.knowledge_base.avatar_image %}
                    <img src="{{ resolve_file(client.knowledge_base.avatar_image, 'avatars') }}"
                        class="w-24 h-24 rounded-full border-4 border-white shadow-lg mb-6 object-cover pointer-events-none">
                    {% endif %}

                    <h1 class="text-4xl font-bold mb-2 shadow-sm pointer-events-none">{{ client.restaurant_name }}</h1>
                    <p class="text-lg opacity-90 italic pointer-events-none">Digital Menu</p>

                    <div class="mt-12 animate-bounce">
                        <span
                            class="text-xs uppercase tracking-widest bg-white/20 px-3 py-1 rounded-full backdrop-blur-sm pointer-events-none">Tap
                            to Open</span>
                    </div>
                </div>
                <!-- Back of Cover: Empty/Decorative -->
                <div class="face back" style="background-color: var(--book-theme-color) !important;"></div>
            </div>

            <!-- Page 1: Table of Contents (Front), Blank (Back) -->
            <div class="page z-[59]" id="page-1" style="background-color: var(--book-theme-color) !important;">
                <div class="face front pt-8 px-6 pb-6" style="background-color: var(--book-theme-color) !important;">
                    <div class="absolute inset-0 flex flex-col items-center overflow-hidden p-6">

                        <!-- Header -->
                        <div class="mb-4 relative w-full text-center">
                            <!-- Back Button (Left) -->
                            <button onclick="flipPrev()"
                                class="absolute left-0 top-1/2 -translate-y-1/2 p-2 opacity-50 hover:opacity-100 transition-opacity"
                                style="color: var(--book-text-color);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>

                            <h2 class="text-3xl font-bold tracking-tight uppercase px-8"
                                style="font-family: 'Playfair Display', serif; color: var(--book-text-color);">
                                {{ client.knowledge_base.toc_title or 'Table of Contents' }}
                            </h2>
                            <div class="w-16 h-1 bg-current mx-auto mt-3 opacity-30 rounded-full"></div>

                            <!-- Next Button (Right) -->
                            <button onclick="flipNext()"
                                class="absolute right-0 top-1/2 -translate-y-1/2 p-2 opacity-50 hover:opacity-100 transition-opacity"
                                style="color: var(--book-text-color);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7">
                                    </path>
                                </svg>
                            </button>
                        </div>

                        <!-- List Container (Scrollable if needed) -->
                        <div class="menu-grid flex-1 w-full max-w-sm flex flex-col justify-center gap-3 min-h-0 overflow-y-auto pr-1 custom-scrollbar touch-pan-y pointer-events-auto"
                            style="overscroll-behavior-y: contain; -webkit-overflow-scrolling: touch; position: relative; z-index: 50; transform: translateZ(0); backface-visibility: hidden;">
                            {% for category in sorted_categories %}
                            <div onclick="window.jumpToCategory('{{ category }}')"
                                class="group relative cursor-pointer overflow-hidden rounded-xl bg-white/10 backdrop-blur-md border border-white/25 shadow-sm mb-3 transition-colors duration-300 hover:bg-white/20">
                                <div class="relative z-10 p-4 flex items-center justify-between">
                                    <span class="text-lg font-bold tracking-wide uppercase truncate pr-4"
                                        style="color: var(--book-text-color);">
                                        {{ category }}
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center transition-colors group-hover:bg-white/20">
                                        <svg class="w-4 h-4 opacity-70 group-hover:opacity-100"
                                            style="color: var(--book-text-color);" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                            <!-- Last Page Link -->
                            <div data-target="{{ client.knowledge_base.last_page_title or 'Thank You' }}"
                                onclick="window.jumpToCategory(this.getAttribute('data-target'))"
                                class="group relative cursor-pointer overflow-hidden rounded-xl bg-white/10 backdrop-blur-md border border-white/25 shadow-sm transition-colors duration-300 hover:bg-white/20">
                                <div class="relative z-10 p-4 flex items-center justify-between">
                                    <span class="text-lg font-bold tracking-wide uppercase truncate pr-4"
                                        style="color: var(--book-text-color);">
                                        Order & Reservation
                                    </span>
                                    <div
                                        class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center transition-colors group-hover:bg-white/20">
                                        <svg class="w-4 h-4 opacity-70 group-hover:opacity-100"
                                            style="color: var(--book-text-color);" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="mt-8 text-center animate-pulse">
                            <p class="text-xs uppercase tracking-widest opacity-60 font-medium"
                                style="color: var(--book-text-color);">
                                {{ client.knowledge_base.toc_footer_text or 'Tap to browse menu' }}
                            </p>
                        </div>
                    </div>
                    <div class="face back" style="background-color: var(--book-theme-color) !important;"></div>
                </div>

                <!-- Content Pages: 1 Category per Page -->
                {% set ns = namespace(page_idx=2) %} <!-- Start at Page 2 (0=Cover, 1=TOC) -->

                {% for cat in sorted_categories %}
                {% set items = menu_by_cat[cat] %}
                <div class="page z-[{{ 58 - (ns.page_idx - 2) }}]" id="page-{{ ns.page_idx }}"
                    style="background-color: var(--book-theme-color) !important;">
                    <div class="face front" style="background-color: var(--book-theme-color) !important;">
                        <div class="absolute inset-0 flex flex-col overflow-hidden p-6">
                            <!-- Premium Category Header -->
                            <div class="mb-8 relative py-4 text-center">
                                <!-- Back Button (Left) -->
                                <button onclick="flipPrev()"
                                    class="absolute left-0 top-1/2 -translate-y-1/2 p-2 opacity-50 hover:opacity-100 transition-opacity"
                                    style="color: var(--book-text-color);">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 19l-7-7 7-7"></path>
                                    </svg>
                                </button>

                                <h2 class="text-3xl font-bold tracking-tight uppercase px-8"
                                    style="font-family: 'Playfair Display', serif; color: var(--book-text-color);">
                                    {{ cat }}
                                </h2>
                                <div class="w-12 h-1 bg-current mx-auto mt-2 opacity-30 rounded-full"></div>

                                <!-- Next Button (Right) -->
                                <button onclick="flipNext()"
                                    class="absolute right-0 top-1/2 -translate-y-1/2 p-2 opacity-50 hover:opacity-100 transition-opacity"
                                    style="color: var(--book-text-color);">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="menu-grid flex-1 w-full min-h-0 overflow-y-auto pr-2 custom-scrollbar touch-pan-y pointer-events-auto"
                                style="overscroll-behavior-y: contain; -webkit-overflow-scrolling: touch; position: relative; z-index: 50; transform: translateZ(0); backface-visibility: hidden;">
                                {% for item in items %}
                                <div class="group mb-6 last:mb-0 transition-all duration-300">
                                    <div class="flex gap-4 items-start pb-4 border-b border-current/10">
                                        {% if item.image_url %}
                                        <div class="w-20 h-20 shrink-0 rounded-2xl overflow-hidden shadow-md menu-item-image ring-1 ring-white/10"
                                            style="touch-action: pan-y;"
                                            data-img-url="{{ resolve_file(item.image_url, 'menu', width=1200) }}"
                                            onclick="event.stopPropagation(); openLightbox(this.dataset.imgUrl)">
                                            <!-- Thumbnail: Optimized to 400px width (Retina ready for 80px container) -->
                                            <img src="{{ resolve_file(item.image_url, 'menu', width=400) }}"
                                                loading="lazy"
                                                class="w-full h-full object-cover md:transform md:group-hover:scale-110 transition-transform duration-700">
                                        </div>
                                        {% endif %}

                                        <div class="flex-1 min-w-0">
                                            <div class="flex justify-between items-baseline gap-2 mb-1">
                                                <h3 class="text-base font-bold tracking-wide truncate"
                                                    style="color: var(--book-text-color);">
                                                    {{ item.name }}
                                                </h3>
                                                <div class="flex-shrink-0">
                                                    <span class="text-sm font-bold px-2 py-0.5 rounded bg-white/10"
                                                        style="color: var(--book-text-color);">
                                                        {{ currency }}{{ "{:,.0f}".format(item.price).replace(',', '.')
                                                        }}
                                                    </span>
                                                </div>
                                            </div>
                                            <p class="text-[11px] leading-relaxed opacity-70 line-clamp-3"
                                                style="color: var(--book-text-color);">
                                                {{ item.description or 'Exquisite flavors crafted with precision.' }}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Scroll Indicator -->
                            <!-- Scroll Indicator -->
                            <div
                                class="scroll-indicator w-full py-2 flex justify-center pointer-events-none animate-bounce opacity-50 z-20 transition-opacity duration-300">
                                <div class="flex flex-col items-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        style="color: var(--book-text-color);">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>

                            <!-- Page Footer -->
                            <div class="mt-4 text-center">
                                <p class="text-[10px] tracking-widest uppercase opacity-40">
                                    {{ client.restaurant_name }} • Page {{ ns.page_idx }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- Empty Back Face -->
                    <div class="face back" style="background-color: var(--book-theme-color) !important;"></div>
                </div>
                {% set ns.page_idx = ns.page_idx + 1 %}
                {% endfor %}

                <!-- Last Page: Back Cover (Optional) -->
                <div class="page z-[{{ 58 - (ns.page_idx - 2) - 1 }}]" id="page-{{ ns.page_idx }}">
                    <div class="face front pt-4 p-8" style="background-color: var(--book-theme-color) !important;">
                        <div class="absolute inset-0 flex flex-col overflow-hidden p-8">

                            <!-- 1. Header (Standard Category Style) -->
                            <div class="mb-4 relative py-4 text-center">
                                <h2 class="text-3xl font-bold tracking-tight uppercase"
                                    style="font-family: 'Playfair Display', serif; color: var(--book-text-color);">
                                    {{ client.knowledge_base.last_page_title or 'Thank You' }}
                                </h2>
                                <div class="w-12 h-1 bg-current mx-auto mt-2 opacity-30 rounded-full"></div>
                            </div>

                            <!-- Middle Content Wrapper (Full Width - Scrollable) -->
                            <div class="menu-grid flex-1 w-full min-h-0 overflow-y-auto pr-2 custom-scrollbar touch-pan-y pointer-events-auto"
                                style="overscroll-behavior-y: contain; -webkit-overflow-scrolling: touch; position: relative; z-index: 50; transform: translateZ(0); backface-visibility: hidden;">

                                <!-- 2. Order Online Area -->
                                <div
                                    class="group relative bg-gradient-to-br from-white/20 to-white/5 backdrop-blur-md p-5 rounded-3xl border border-white/30 shadow-lg shrink-0">
                                    <div class="relative z-10 flex flex-col items-center">
                                        <div
                                            class="w-10 h-10 mb-2 bg-white/20 rounded-full flex items-center justify-center shadow-inner">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-xl font-bold mb-1 uppercase tracking-wider text-center"
                                            style="color: var(--book-text-color);">Order Online</h3>
                                        <p class="autolink-content text-sm font-medium mb-3 opacity-90 leading-relaxed text-center whitespace-pre-line break-words w-full"
                                            style="color: var(--book-text-color);">
                                            {{ client.knowledge_base.last_page_order_desc }}
                                        </p>
                                        {% if client.delivery_url or client.website_url %}
                                        <a href="{{ client.delivery_url or client.website_url }}" target="_blank"
                                            class="inline-flex items-center gap-2 px-6 py-2 bg-white text-gray-900 rounded-full font-bold text-sm shadow-md hover:bg-gray-50 transition-colors">
                                            <span>Order Now</span>
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                            </svg>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- 3. Reservation Area -->
                                <div
                                    class="group relative bg-gradient-to-br from-white/20 to-white/5 backdrop-blur-md p-5 rounded-3xl border border-white/30 shadow-lg shrink-0">
                                    <div class="relative z-10 flex flex-col items-center">
                                        <div
                                            class="w-10 h-10 mb-2 bg-white/20 rounded-full flex items-center justify-center shadow-inner">
                                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 9h14l1 12H4L5 9z"></path>
                                            </svg>
                                        </div>
                                        <h3 class="text-xl font-bold mb-1 uppercase tracking-wider text-center"
                                            style="color: var(--book-text-color);">Reservations</h3>
                                        <p class="autolink-content text-sm font-medium mb-3 opacity-90 leading-relaxed text-center whitespace-pre-line break-words w-full"
                                            style="color: var(--book-text-color);">
                                            {{ client.knowledge_base.last_page_res_desc }}
                                        </p>
                                        {% if client.booking_url or client.public_phone %}
                                        <a href="{{ client.booking_url or 'tel:' + client.public_phone }}"
                                            target="_blank"
                                            class="inline-flex items-center gap-2 px-6 py-2 bg-white text-gray-900 rounded-full font-bold text-sm shadow-md hover:bg-gray-50 transition-colors">
                                            <span>Book a Table</span>
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                                                </path>
                                            </svg>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Standard Page Footer -->
                            <div class="mt-4 text-center">
                                <p class="text-[10px] tracking-widest uppercase opacity-40">
                                    {{ client.restaurant_name }} • Page End
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="face back" style="background-color: var(--book-theme-color) !important;"></div>
                </div>

                {% set ns.page_idx = ns.page_idx + 1 %}

                <!-- Store Total Pages for JS -->
                <input type="hidden" id="totalPages" value="{{ ns.page_idx }}">

            </div>
        </div>

        <!-- Lightbox Modal -->
        <div id="lightbox" onclick="closeLightbox()">
            <button class="close-lightbox" aria-label="Close lightbox">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
            <img id="lightbox-img" src="" alt="Menu Item Large View" onclick="event.stopPropagation()">
        </div>

        <!-- Navigation Overlay Hints -->
        <div class="nav-hint nav-right text-gray-600">
            <svg class="w-8 h-8 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </div>

        <script>
            const book = document.getElementById('book');
            const totalPagesRaw = document.getElementById('totalPages').value;
            const totalPages = parseInt(totalPagesRaw);

            let currentPage = 0; // 0 = Cover
            const pages = document.querySelectorAll('.page');

            // Initial Z-Index is set by Jinja for the stack. 
            // JS only needs to handle z-index for the FLIPPED pile (Left Stack).
            // Since we are "Single Page Focus", the Left Stack is essentially "discarded".
            // We just need to make sure the TOPmost Left Page is BEHIND the book spine visual if any?
            // Actually simple logic: Flipped pages have z-index = index.
            // Page 0 (Flip) -> z-0.
            // Page 1 (Flip) -> z-1.
            // So recently flipped page is ON TOP of the left stack. That is correct.

            let isFlipping = false;

            function updateVisibility() {
                pages.forEach((page, index) => {
                    // Reset basic properties
                    page.style.display = 'block';
                    page.style.visibility = 'visible';

                    if (index < currentPage) {
                        // Left stack (already flipped)
                        page.classList.add('flipped');
                        page.style.zIndex = index;
                        page.style.pointerEvents = 'none';
                    } else if (index === currentPage) {
                        // Active page (centered)
                        page.classList.remove('flipped');
                        page.style.zIndex = 100;
                        page.style.pointerEvents = isFlipping ? 'none' : 'auto';
                    } else if (index === currentPage + 1) {
                        // Peek next
                        page.classList.remove('flipped');
                        page.style.zIndex = 50;
                        page.style.pointerEvents = 'none';
                    } else {
                        // Hidden
                        page.style.display = 'none';
                        page.style.pointerEvents = 'none';
                    }
                });
            }

            function flipNext() {
                if (currentPage < pages.length - 1 && !isFlipping) {
                    const currentEl = document.getElementById(`page-${currentPage}`);
                    if (currentEl) {
                        isFlipping = true;
                        // Start animation by adding class
                        currentEl.classList.add('flipped');
                        currentEl.style.zIndex = 150; // Ensure it's on top DURING flip

                        setTimeout(() => {
                            currentPage++;
                            isFlipping = false;
                            updateVisibility();
                        }, 800); // Match CSS transition duration
                    }
                }
            }

            function flipPrev() {
                if (currentPage > 0 && !isFlipping) {
                    isFlipping = true;
                    currentPage--;
                    const prevEl = document.getElementById(`page-${currentPage}`);
                    if (prevEl) {
                        prevEl.style.zIndex = 150; // Bring it back to top
                        // Trigger animation by removing class
                        setTimeout(() => {
                            prevEl.classList.remove('flipped');
                            setTimeout(() => {
                                isFlipping = false;
                                updateVisibility();
                            }, 800);
                        }, 10);
                    }
                }
            }

            // Initial setup
            updateVisibility();

            // Click Handling
            pages.forEach((page, index) => {
                page.addEventListener('click', (e) => {
                    e.stopPropagation();

                    // Only navigate on the current active centered page
                    if (index !== currentPage) return;

                    const rect = page.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const width = rect.width;

                    if (x > width / 2) {
                        flipNext();
                    } else {
                        flipPrev();
                    }
                });
            });

            // Touch logic with Scroll Protection
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;

            /*
            document.addEventListener('touchstart', e => {
                // CRITICAL: If touching menu grid, let browser handle native scroll. DO NOT INTERFERE.
                if (e.target.closest('.menu-grid')) return;
    
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });
    
            document.addEventListener('touchend', e => {
                // CRITICAL: Ignore interaction if it started/ended in grid
                if (e.target.closest('.menu-grid')) return;
                if (touchStartX === 0 && touchStartY === 0) return; // touches ignored by start
    
                touchEndX = e.changedTouches[0].screenX;
                let touchEndY = e.changedTouches[0].screenY;
    
                // Calculate differences
                let xDiff = touchEndX - touchStartX;
                let yDiff = touchEndY - touchStartY;
    
                // If vertical scroll is significant, IGNORE (it was a scroll, not a swap)
                if (Math.abs(yDiff) > Math.abs(xDiff)) return;
    
                if (xDiff < -50) flipNext();
                if (xDiff > 50) flipPrev();
    
                // Reset
                touchStartX = 0;
                touchStartY = 0;
            }, { passive: true });
            */

            // Jump to Category
            // Note: Logic needs to find which page the header is on.
            // The structure is flat now, so it should be robust.
            function jumpToCategory(categoryName) {
                const headers = document.querySelectorAll('h2');
                let targetHeader = null;
                for (let h of headers) {
                    if (h.innerText.trim() === categoryName) {
                        targetHeader = h;
                        break;
                    }
                }
                if (!targetHeader) return;
                const parentPage = targetHeader.closest('.page');
                if (!parentPage) return;

                const pageId = parentPage.id;
                const targetIndex = parseInt(pageId.split('-')[1]);

                if (targetIndex === currentPage) return;

                // Fast Sequential Flip (No Blackout)
                const direction = targetIndex > currentPage ? 1 : -1;
                isFlipping = true; // Lock interaction

                function step() {
                    if (currentPage === targetIndex) {
                        isFlipping = false;
                        updateVisibility(); // Restore clicks
                        return;
                    }
                    currentPage += direction;
                    updateVisibility();

                    // Speed depends on distance? Fixed 150ms is good for "riffling" effect
                    setTimeout(step, 150);
                }
                step();
            }

            // Lightbox Functions
            function openLightbox(src) {
                const lb = document.getElementById('lightbox');
                const img = document.getElementById('lightbox-img');
                img.src = src;
                lb.style.display = 'flex';
                setTimeout(() => {
                    lb.classList.add('show');
                }, 10);
                // Hide parent's close button
                if (window.parent) {
                    window.parent.postMessage({ type: 'TOGGLE_CLOSE_BUTTON', show: false }, '*');
                }
            }

            function closeLightbox() {
                const lb = document.getElementById('lightbox');
                lb.classList.remove('show');
                setTimeout(() => {
                    lb.style.display = 'none';
                }, 300);
                // Show parent's close button
                if (window.parent) {
                    window.parent.postMessage({ type: 'TOGGLE_CLOSE_BUTTON', show: true }, '*');
                }
            }

            // Initialize Auto-Link
            document.addEventListener('DOMContentLoaded', () => {
                // Linkify Function
                const linkify = (text) => {
                    const urlRegex = /(https?:\/\/[^\s]+)/g;
                    return text.replace(urlRegex, (url) => {
                        const cleanUrl = url.replace(/[.,;!]$/, '');
                        return `<a href="${cleanUrl}" target="_blank" class="underline decoration-white/50 hover:decoration-white transition-colors break-all relative z-50 pointer-events-auto cursor-pointer" onclick="event.stopPropagation(); window.open('${cleanUrl}', '_blank'); return false;">${cleanUrl}</a>`;
                    });
                };

                // Apply to specific content
                document.querySelectorAll('.autolink-content').forEach(el => {
                    el.innerHTML = linkify(el.innerHTML);
                });

                // Smart Scroll Indicator
                const menuGrids = document.querySelectorAll('.menu-grid');
                const checkScroll = (grid) => {
                    const indicator = grid.nextElementSibling;
                    if (!indicator || !indicator.classList.contains('scroll-indicator')) return;

                    // Threshold: only show if content is significantly larger (>20px) to avoid false positives
                    const isScrollable = (grid.scrollHeight - grid.clientHeight) > 10;

                    // Check if user is near bottom
                    const isAtBottom = Math.ceil(grid.scrollTop + grid.clientHeight) >= (grid.scrollHeight - 5);

                    if (!isScrollable) {
                        indicator.style.display = 'none'; // Safe to hide if content is short
                        indicator.style.opacity = '0';
                    } else if (isAtBottom) {
                        indicator.style.opacity = '0'; // Only fade out, KEEP SPACE to prevent layout jump
                    } else {
                        indicator.style.display = 'flex'; // Ensure visible
                        // Force reflow
                        void indicator.offsetWidth;
                        indicator.style.opacity = '0.5'; // Fade in
                    }
                };

                const initScrollMonitors = () => {
                    menuGrids.forEach(grid => {
                        // 1. Initial Check
                        checkScroll(grid);

                        // 2. Scroll Listener
                        grid.addEventListener('scroll', () => {
                            const indicator = grid.nextElementSibling;
                            if (indicator && indicator.classList.contains('scroll-indicator')) {
                                indicator.style.display = 'flex'; // Ensure generic display before opacity transition
                            }
                            checkScroll(grid);
                        });

                        // 3. Resize Observer (Detects image loads / content changes)
                        const resizeObserver = new ResizeObserver(() => checkScroll(grid));
                        resizeObserver.observe(grid);
                        Array.from(grid.children).forEach(child => resizeObserver.observe(child));
                    });
                };

                // Run on DOM Ready
                initScrollMonitors();

                // Run again on Window Load (ensure all images loaded)
                window.addEventListener('load', () => {
                    menuGrids.forEach(checkScroll);
                });
            });
        </script>
</body>

</html>